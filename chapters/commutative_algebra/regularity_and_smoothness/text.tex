\section{Smoothness}

\subsection{Modules of differentials and derivations}

    In this subsection, let $R$ be a ring and $A$ an $R$-algebra.

    \begin{definition}[Derivation]\label{def: derivation}
        A \emph{derivation} of $A$ over $R$ is an $R$-linear map $\P: A \to M$ with an $A$-module such that for all $a, b \in A$, we have
        \[
            \P(ab) = a\P(b) + b\P(a).
        \]
        Given the module $M$, the set of all derivations of $A$ over $R$ into $M$ forms an \(A\)-module, denoted by $\Der_R(A, M)$.
    \end{definition}

    Given a module homomorphism \(f: M \to N\) of \(A\)-modules and a derivation \(\P \in \Der_R(A, M)\), the map $f \circ \P$ is a derivation of \(A\) over \(R\) into \(N\).

    \begin{proposition}\label{prop: module of differentials}
        The functor \(\Der_R(A, -)\) is representable.
        The representing object is denoted by \(\Omega_{A/R}\), which is called the \emph{module of differentials} of \(A\) over \(R\).
    \end{proposition}
    \begin{proof}
        First suppose \(A\) is a free \(R\)-algebra with a set of generators \(a_\lambda, \lambda \in \Lambda\).
        Then an \(R\)-derivation \(\P \in \Der_R(A, M)\) is uniquely determined by its values on the generators \(a_\lambda\).
        Let 
        \[ \Omega_{A/R} \coloneqq \bigoplus_{\lambda \in \Lambda} A \cdot \d a_\lambda\]
        and \(\d: A \to \Omega_{A/R}\) be the \(R\)-derivation defined by \(a_\lambda \mapsto \d a_\lambda\).
        For any \(R\)-derivation \(\P \in \Der_R(A, M)\), we can define a unique \(A\)-module homomorphism
        \(\Phi_\P: \Omega_{A/R} \to M\) by sending \(\d a_\lambda\) to \(\P(a_\lambda)\) such that \(\P = \Phi_\P \circ \d\).
        This gives a bijection
        \[
            \Der_R(A, M) \cong \Hom_A(\Omega_{A/R}, M), \quad \P \mapsto \Phi_\P.
        \] 

        Now suppose \(A = F/I\) is an arbitrary \(R\)-algebra, where \(F\) is a free \(R\)-algebra and \(I\) is an ideal of \(F\).
        Then we can define the module of differentials 
        \[ \Omega_{A/R} \coloneqq \left(\Omega_{F/R} \ten_F A \right) \Big/ \sum_{f \in I} A \cdot \d f. \]
        The \(R\)-linear map \(\d_A: F\ten_F A \xrightarrow{\d_F} \Omega_{F/R} \ten_F A \to \Omega_{A/R}\) is a derivation of \(A\) over \(R\).
        
        For any \(R\)-derivation \(\P \in \Der_R(A, M)\), note that \(F \to A \xrightarrow{\P} M\) is an \(R\)-derivation of \(F\) over \(R\) into \(M\).
        Then we get an \(F\)-module homomorphism \(\Omega_F \to M\).
        It gives an \(A\)-module homomorphism \(\Omega_F \ten_F A \to M, \d f \ten 1 \mapsto \P f\).
        This map factors into \(\Omega_F \ten_F A \to \Omega_{A/R}\) and \(\Phi_\P: \Omega_{A/R} \to M\).
        Since \(\Phi_\P\) is \(A\)-linear and \(\Omega_{A/R}\) is generated by \(\d a_\lambda\) as \(A\)-module, such \(\Phi_\P\) is unique.
    \end{proof}

    \begin{corollary}\label{cor: module of differentials is finite}
        Suppose \(A\) is of finite type over \(R\).
        Then the module of differentials \(\Omega_{A/R}\) is a finitely generated \(A\)-module.
    \end{corollary}
    
    \begin{remark}\label{rmk: extending homomorphisms (M to N) to tensor products (M ten B to N)}
        Let $B$ be an $A$-algebra, $M$ an \(A\)-module and \(N\) a \(B\)-module.
        If there is a homomorphism of \(A\)-modules \(M \to N\), then we can extend it to a homomorphism of \(B\)-modules \(M \ten_A B \to N\) by sending \(m \ten b\) to \(m \cdot b\).
        And such extension is unique in the sense of following commutative diagram:
        \[
            \xymatrix{
                M \ar[r] \ar[d] & N \\
                M \ten_A B \ar[ru]_{\exists!} & 
            }.
        \]
        Hence we get a natural bijection 
        \[ \Hom_A(M, N) \cong \Hom_B(M \ten_A B, N). \]
        % In particular, if \(\P: B \to M\) is a
        % note that $A \to B \to \Omega_{B/R}$ is an \(R\)-derivation of \(A\).
        % Then we get an \(A\)-linear map \(\Omega_{A/R} \to \Omega_{B/R}\).
        % It extends to a \(B\)-linear map \(\Omega_{A/R} \ten_A B \to \Omega_{B/R}\) by Remark~\ref{rmk: extending homomorphisms (M to N) to tensor products (M ten B to N)}.
    \end{remark}

    % Let \(B\) be an \(A\)-algebra.
    % Note that $A \to B \to \Omega_{B/R}$ is an \(R\)-derivation of \(A\).
    % Then we get an \(A\)-linear map \(\Omega_{A/R} \to \Omega_{B/R}\).
    % It extends to a \(B\)-linear map \(\Omega_{A/R} \ten_A B \to \Omega_{B/R}\) by Remark~\ref{rmk: extending homomorphisms (M to N) to tensor products (M ten B to N)}.
    
    % In the situations of Propositions \ref{prop: module of differentials is stable under base change} and \ref{prop: module of differentials is stable under localization}, 
    % we just need to construct an \(R\)-derivation of \(B\) into \(\Omega_{A/R}\ten_A B\) for \(B = A'\) or \(B = S^{-1}A\) such that the following diagram commutes:
    % \[ \xymatrix{
    %     B \ar[rd] \ar[r] & \Omega_{A/R} \ten_A B \ar[d] \\
    %      & \Omega_{B/R} 
    % } \]
    

    \begin{proposition}\label{prop: module of differentials is stable under base change}
        Let \(A, R'\) be \(R\)-algebras and \(A':= A\ten_R R'\).
        Then the module of differentials \(\Omega_{A'/R'}\) is isomorphic to \(\Omega_{A/R} \ten_A A'\).
    \end{proposition}
    \begin{proof}
        We check the universal property of \(\Omega_{A/R} \ten_A A'\).
        First, the map 
        \[ \d_{A'}: A \ten_R R' \to \Omega_{A/R} \ten_R R' \cong \Omega_{A/R} \ten_A A',\quad a\ten r \mapsto \d a \ten r\]
        is an \(R'\)-derivation of \(A'\) into \(\Omega_{A/R} \ten_A A'\).
        For any \(R'\)-derivation \(\P': A' \to M\) into an \(A'\)-module \(M\), 
        we can compose it with the homomorphism \(A' \to A\) and get an \(R\)-derivation \(\P: A \to M\).
        By the universal property of \(\Omega_{A/R}\), 
        there is a unique \(A\)-module homomorphism \(\Phi: \Omega_{A/R} \to M\) such that \(\P = \Phi \circ \d_A\).
        Then we can extend it to an \(A'\)-module homomorphism \(\Phi': \Omega_{A/R} \ten_A A' \to M\) by Remark~\ref{rmk: extending homomorphisms (M to N) to tensor products (M ten B to N)}.
        By the construction, we have \(\Phi' \circ \d_{A'} = \P'\).
        % First, \Yang{To be completed.}
        % Let \(M\) be an \(A'\)-module and \(\P': A' \to M\) an \(R'\)-derivation.
        % Then we can compose it with \(A \to A'\) and get an \(R\)-derivation \(\P: A \to A' \xrightarrow{\P'} M\).
        % By the universal property of \(\Omega_{A/R}\), there is a unique \(A\)-module homomorphism \(\Phi: \Omega_{A/R} \to M\) such that \(\P = \Phi \circ \d_A\).
        % Then we can extend it to an \(A'\)-module homomorphism \(\Phi': \Omega_{A/R} \ten_A A' \to M\) by Remark~\ref{rmk: extending homomorphisms (M to N) to tensor products (M ten B to N)}.
        % Such \(\Phi'\) is unique by uniqueness of \(\Phi\) and homomorphism in Remark~\ref{rmk: extending homomorphisms (M to N) to tensor products (M ten B to N)}.
    \end{proof}

    \begin{proposition}\label{prop: module of differentials is stable under localization}
        Let \(A\) be an \(R\)-algebra and \(S\) a multiplicative set of \(A\).
        Then we have an isomorphism
        \[
            \Omega_{S^{-1}A/R} \cong  S^{-1}\Omega_{A/R}.
        \]
    \end{proposition}
    \begin{proof}
        Let 
        \[ \d_{S^{-1}A}: S^{-1}A \to S^{-1}\Omega_{A/R}, \quad \frac{a}{s} \mapsto \frac{s\d a - a \d s}{s^2}. \]
        By direct computation, \(\d_{S^{-1}A}\) is an \(R\)-derivation of \(S^{-1}A\) over \(R\) into \(S^{-1}\Omega_{A/R}\).
        For any \(R\)-derivation \(\P: S^{-1}A \to M\) into an \(S^{-1}A\)-module \(M\), 
        we can get an \(S^{-1}A\)-module homomorphism \(\Phi': S^{-1}\Omega_{A/R} \to M\) as proof of Proposition~\ref{prop: module of differentials is stable under base change}. 
        We have 
        \[ \P(s \cdot \frac{a}{s}) = s \P(\frac{a}{s}) + \frac{a}{s}\P s.\]
        It follows that 
        \[ \P (\frac{a}{s}) = \frac{s \P a - a \P s}{s^2} = \frac{s \Phi'(\d a) - a \Phi'(\d s)}{s^2} = \Phi'(\frac{s\d a - a \d s}{s^2}).\]
        Thus, \(\Phi' \circ \d_{S^{-1}A} = \P\).
        % Follow the same argument as in the proof of Proposition~\ref{prop: module of differentials is stable under base change}, 
        % we can show that for any \(R\)-derivation factors through \(A \to S^{-1}\Omega_{A/R}\).
        % Note that \(S^{-1}\Omega_{A/R}\) is generated by elements of the form \(\d a, a \in A\) as \(S^{-1}A\)-module.
        % Thus, such \(\Phi\) is unique.
    \end{proof}

    \begin{theorem}\label{thm: the first exact sequence of differentials}
        Let \(A\) be an \(R\)-algebra and \(B\) an \(A\)-algebra. 
        Then there is a natural short exact sequence
        \[ \Omega_{A/R} \ten_A B \to \Omega_{B/R} \to \Omega_{B/A} \to 0 \]
        of \(B\)-modules.
    \end{theorem}
    \begin{proof}
        Let \(\d_{A/R}: A \to \Omega_{A/R}\) be the \(R\)-derivation of \(A\) over \(R\).
        The map \(A \to B \xrightarrow{\d_{B/R}} \Omega_{B/R}\) induces a \(B\)-linear map 
        \[ u: \Omega_{A/R} \ten_A B \to \Omega_{B/R}, \quad \d_{A/R}(a) \ten b \mapsto b\d_{B/R}(a). \]
        
        The map \(\d_{B/A}\) is an \(A\)-derivation and hence \(R\)-derivation.
        Then it induces a \(B\)-linear map 
        \[ v: \Omega_{B/R} \to \Omega_{B/A}, \quad \d_{B/R}(b) \mapsto \d_{B/A}(b). \]

        Since \(\Omega_{B/A}\) is generated by elements of the form \(\d_{B/A}(b)\) for \(b \in B\),
        the map \(v\) is surjective.
        And clearly \(\d_{B/A}(a) = a\d_{B/A}(1) = 0\) for \(a \in A\). 

        Consider the composition \( B \xrightarrow{\d_{B/R}} \Omega_{B/R} \to \Omega_{B/R}/\Im u\).
        For every \(a \in A, b\in B\), we have 
        \[ [\d_{B/R}(ab)] = [b\d_{B/R}(a) + a\d_{B/R}(b)] = [b\d_{B/R}(a)] + [a\d_{B/A}(b)] = [a\d_{B/A}(b)]. \]
        Hence it is indeed an \(A\)-derivation of \(B\).
        Then it induces a \(B\)-linear map 
        \[ \varphi: \Omega_{B/A} \to \Omega_{B/R}/\Im u, \quad \d_{B/A}(b) \mapsto [\d_{B/R}(b)]. \]
        The map \(\varphi\) is surjective since \(\Omega_{B/R}\) is generated by elements of the form \(\d_{B/R}(b)\) for \(b \in B\).
        Note that the composition 
        \[ \Omega_{B/A} \xrightarrow{\varphi} \Omega_{B/R}/\Im u \to \Omega_{B/A}/\Ker v \]
        is the identity map.
        Thus, \(\varphi\) is injective and hence an isomorphism.
        In particular, we have \(\Ker v = \Im u\).
    \end{proof}

    \begin{remark}\label{rmk: the first exact sequence of differentials is left exact}
        The exact sequence in Theorem~\ref{thm: the first exact sequence of differentials} is left exact 
        if and only if every \(R\)-derivation of \(A\) into \(B\)-module extends to an \(R\)-derivation of \(B\) into \(B\)-module.
        
        \Yang{To be completed.}
    \end{remark}

    \begin{theorem}\label{thm: the second exact sequence of differentials}
        Let \(A\) be an \(R\)-algebra and \(I\) an ideal of \(A\).
        Set \(B \coloneqq A/I\).
        Then there is a natural short exact sequence
        \[ I/I^2 \to \Omega_{A/R} \ten_A B \to \Omega_{B/R} \to 0 \]
        of \(B\)-modules.
    \end{theorem}
    \begin{proof}
        Suppose \(A = F/\frakb\) for some free \(R\)-algebra \(F\) and an ideal \(\frakb\) of \(F\).
        Let \(\fraka\) be the preimage of \(I\) in \(F\).
        Let \(\d \frakb\) (resp. \(\d \fraka\)) denote the image of \(\frakb\) (resp. \(\fraka\)) in \(\Omega_{F/R}\).
        Then we have 
        \[ \Omega_{A/R} \ten_A B = \Omega_{F/R} \ten_F B / (\d \frakb \ten_F B), \quad \Omega_{B/R} = \Omega_{F/R} \ten_F B / (\d \fraka \ten_F B). \]
        Clearly 
        \[ I/I^2 \cong (\fraka/\frakb)\ten_F B \to (\d \fraka \ten_F B)/(\d \frakb \ten_F B) \]
        is surjective.
        Then the exact sequence follows.
    \end{proof}

    \begin{definition}\label{def: smoothness of affine algebraic varieties}
        Let \(\kk\) be a field and \(A\) an integral \(\kk\)-algebra of finite type of dimension $n$.
        We say \(A\) is \emph{smooth at \(\frakp \in \Spec A\)} if the module of differentials \(\Omega_{A,\frakp}\) is a free \(A_\frakp\)-module of rank \(n\).
    \end{definition}

    \begin{example}\label{eg: module of differential for field extensions}
        Let \(\KK/\kk\) be a finite generated field extension and \(\kk'\) be the algebraic closure of \(\kk\) in \(\KK\).
        Then 
        \[ \dim_\KK \Omega_{\KK/\kk} = \trdeg(\KK/\kk) + \dim_{\kk'} \Omega_{\kk'/\kk}, \]
        and \(\dim_{\kk'} \Omega_{\kk'/\kk} = 0\) if and only if \(\kk'\) is separable over \(\kk\).

        First suppose \(\KK = \kk'\) is algebraic over \(\kk\).
        Suppose \(\kk'/\kk\) is separable.
        For every \(\alpha \in \kk'\), suppose \(f(\alpha) = 0\) for \(f \in \kk[T]\).
        Then \(\d f(\alpha) = f'(\alpha) \d \alpha = 0\).
        By the separability of \(\kk'/\kk\), we have \(f'(\alpha) \neq 0\).
        It follows that \(\d \alpha = 0\).
        Conversely, let \(\alpha \in \kk'\) be a inseparable element over \(\kk\).
        Since \(\kk[\alpha] \to \kk[\alpha], \alpha^n \mapsto n\alpha^{n-1}\) is a non-zero \(R\)-derivation, we have \(\Omega_{\kk[\alpha]/\kk} \neq 0\).
        By induction on number of generated elements, choosing a middle field \(\kk \subset \kk'' \subset \kk'\), at least one of \(\Omega_{\kk''/\kk}\) and \(\Omega_{\kk'/\kk''}\) is non-zero.
        Then \(\Omega_{\KK/\kk} \neq 0\) by Theorem \ref{thm: the first exact sequence of differentials}.

        Then suppose \(\kk' = \kk\).
        By the Noether's Normalization Lemma, we can find a finite set of elements \(T_1, \cdots, T_n \in \KK\) such that \(\KK\) is algebraic over \(\kk'(T_1, \ldots, T_n)\).
        Note that we can choose \(T_i\) such that \(\KK/\kk'(T_1, \cdots, T_n)\) is separable.
        To see this, if \(\alpha \in \KK\) is an inseparable element over \(\kk'(T_1,\cdots,T_n)\), 
        then by replacing a suitable \(T_i\) with \(\alpha\), we reduce the inseparable degree of \(\KK/\kk'(T_1, \cdots, T_n)\).
        
        Since \(\KK/\kk'(T_1, \cdots, T_n)\) is finite, every \(\kk\)-derivation of \(\kk'(T_1,\cdots,T_n)\) into \(\KK\)-module extends to a \(\kk\)-derivation of \(\KK\) into \(\KK\)-module.
        Then by Remark~\ref{rmk: the first exact sequence of differentials is left exact}, we have 
        % \[ \dim_{\KK} \Omega_{\KK/\kk'} = \dim_{\kk'(T_1,\cdots,T_n)} \Omega_{\kk'(T_1, \cdots, T_n)/\kk'} = n. \]
        \[ 0 \to \Omega_{\kk'(T_1, \cdots, T_n)/\kk} \ten_{\kk'(T_1,\cdots,T_n)} \KK \to \Omega_{\KK/\kk} \to \Omega_{\KK/\kk'(T_1,\cdots,T_n)} \to 0. \]
        
        Finally, note that every \(\kk\)-derivation \(\P\) of \(\kk'\) into \(\KK\)-module can be extended to \(\kk'[T_1,\cdots,T_n]\) by setting \(\P T_i = 0\).
        Thus, we have 
        \[ 0 \to \Omega_{\kk'/\kk} \ten_{\kk'} \kk'[T_1,\cdots,T_n] \to \Omega_{\kk'[T_1,\cdots,T_n]/\kk} \to \Omega_{\kk'[T_1,\cdots,T_n]/\kk'} \to 0. \]
        This follows that 
        \[ \dim_\KK \Omega_{\KK/\kk} = \dim_{\KK} \Omega_{\KK/\kk'} + \dim_{\kk'}\Omega_{\kk'/\kk}. \]
    \end{example}


\subsection{Applications to affine varieties}

    % \begin{proposition}\label{prop: regularity and separable imply smoothness}
    %     Let \(\kk\) be a field, \(A\) an integral \(\kk\)-algebra of finite type and \(\frakm\in \mSpec A\) such that .
    %     Suppose \(A\) is regular at \(\frakm \in \mSpec A\) and \(\rkk(\frakm)\) is a separable over \(\kk\).
    %     Then \(A\) is smooth at \(\frakm\).
    % \end{proposition}
    % \begin{proof}
    %     \Yang{To be completed.}
    % \end{proof}

    Let \(\kk\) be arbitrary field, \(A = \kk[T_1, \ldots, T_n]\) and \(\frakm\) a maximal ideal of \(A\) such that \(\rkk(\frakm)\) is separable over \(\kk\).
    We try to give an explanation of Zariski's tangent space at \(\frakm\) using the language of derivation.
    We know that \( \Omega_{A/\kk} = \bigoplus_{i=1}^n A \d T_i \), thus \(\Omega_{A_\frakm/\kk} \cong \bigoplus_{i=1}^n A_\frakm \d T_i\). 
    Then 
    \[ \Der_\kk(A_\frakm, A_\frakm) \cong \Hom_\kk(\Omega_{A_\frakm/\kk}, A_\frakm) \cong \bigoplus_{i=1}^n A_\frakm \P_i, \]
    where \(\P_i \in \Der_\kk(A_\frakm, A_\frakm)\) is the derivation defined by \(\d T_i \mapsto 1\) and \(\d T_j \mapsto 0\) for \(j \neq i\).
    It coincides with the usual derivation \(f \mapsto \P f/ \P T_i\).
    Consider the restriction of \(\P_i\) to \(\frakm\) and take values in the residue field \(\rkk(\frakm)\), we get 
    \[ \Phi : \frakm \xrightarrow{(\P_1,\cdots,\P_n)^T} A_\frakm^n \to \rkk(\frakm)^n.\]
    Since \(\rkk(\frakm)\) is separable over \(\kk\), we claim that \(\Ker \Phi = \frakm^2\).
    Indeed, by Remark \ref{remark: Taylor expansion with respect to irreducible polynomials}, we can write every \(f \in \frakm \setminus \frakm^2\) as \(\sum_i a_i g_i\).
    Then 
    \[ \frac{\P f}{\P T_i} = a_i \frac{\P g_i}{\P T_i} + g_i \frac{\P a_i}{\P T_i}. \]
    Since \(g_i\) is separable, the image of \(\P g_i/\P T_i\) in \(\rkk(\frakm)\) is not zero.
    Hence \(\Phi(f) \neq 0\).
    By the claim, \(\Phi\) induces an isomorphism \( \frakm/{\frakm^2} \cong \rkk(\frakm)^n \) of \(\rkk(\frakm)\)-vector spaces.
    Then we get 
    \[ T_{A,\frakm} = (\frakm/\frakm^2)^\lor \cong \bigoplus_{i=1}^n \rkk(\frakm)\cdot \P_i|_x, \]
    where \(x \in \bba_\kk^n\) is the point corresponding to \(\frakm\).
    This coincides with the usual tangent space at \(x\) in language of differential geometry.

    \begin{remark}\label{remark: Taylor expansion with respect to irreducible polynomials}
        Let \(\kk\) be arbitrary field, \(A = \kk[T_1,\cdots,T_n]\) and \(g_i\) irreducible polynomials in one variable \(T_i\) over \(\kk\).
        Then for every \(f \in A\), we can write
        \[ f = \sum_{I=(i_1,\cdots,i_n) \in \bbz_{\geq 0}^n} a_I g_1^{i_1}\cdots g_n^{i_n}, \quad a_I \in A, \quad \deg_{T_i} a_I \leq \deg g_i.\]
        This is called the \textit{Taylor expansion of \(f\) with respect to \(g_1,\cdots,g_n\)}. 

        When \(n = 1\), it follows from division algorithm.
        For \(n > 1\), we can use induction on \(n\).
        Let \(\KK = \kk(T_1,\cdots,T_{n-1})\).
        Then we can write \(f\) as
        \[ f = \sum_{i=0}^{r} a_i g_n^i, \quad a_i \in \KK[T_n],\quad \deg a_i < \deg g_n. \]
        Comparing the coefficients of two sides from the highest degree of \(T_n\) to the lowest degree, we see that 
        \[a_i \in \kk[T_1,\cdots,T_{n-1}].\]
        By induction hypothesis, the conclusion follows.
    \end{remark}

    Let \(B = A/I\) be a \(\kk\) of finite type, \(I = (F_1,\ldots,F_m) \subset \frakm\) and \(\frakn\) the image of \(\frakm\) in \(B\).
    We have an exact sequence of \(\rkk(\frakm)\)-vector spaces
    \[ 0 \to I/(I\cap \frakm^2) \to \frakm/\frakm^2 \to \frakn/\frakn^2 \to 0. \]
    It induces an isomorphism
    \[ T_{B,\frakn} \cong \{ \P \in T_{A,\frakm} \colon \P(f) = 0, \forall f \in I \}. \] 

    The \emph{Jacobian matrix} of \(F_1, \ldots, F_m\) is the \(m \times n\) matrix
    \[
        J(F_1, \ldots, F_m) \coloneqq \left( \frac{\partial F_i}{\partial T_j} \right)_{1 \leq i \leq m, 1 \leq j \leq n}
    \] 
    with entries in \(B\).

    \begin{theorem}\label{thm: Jacobian criterion}
        % Let \(\kk\) be a field and \(A = \kk[T_1, \ldots, T_n]/I\) a \(\kk\)-algebra of finite type.
        % Let \(F_1, \ldots, F_m\) be a set of generators of the ideal \(I\) and \(J\) the Jacobian matrix of \(F_1, \ldots, F_m\).
        % Suppose \(\frakm \in \mSpec A\) is a maximal ideal such that \(\rkk(\frakm)\) is separable over \(\kk\). 
        Setting as above.
        Then \(B\) is regular at \(\frakn\) if and only if the Jacobian matrix \(J\) has maximal rank \(n - \dim B_\frakn\) after taking values in the residue field \(\rkk(\frakm)\).
    \end{theorem}
    \begin{proof}
        We have an exact sequence
        \[ 0 \to T_{B,\frakn} \to T_{A,\frakm} \xrightarrow{\Psi} \rkk^m \to 0, \]
        where \(\Psi\) sends \(\P \in T_{A,\frakm}\) to \((\P(F_1), \ldots, \P(F_m))^T \).
        Note that the matrix of \(\Psi\) is just \(J^T\), the transpose of the Jacobian matrix.
        Hence 
        \[ \rank J = n - \dim_\rkk T_{B,\frakn} \leq n - \dim B_\frakn \] 
        and the equality holds if and only if \(B\) is regular at \(\frakn\).
    \end{proof}

    \begin{remark}\label{rmk: rank of Jacobian matrix for inseparable extensions}
        If \(\rkk(\frakm)\) is not separable over \(\kk\), then we still have the inequality
        \[ \rank J \leq n - \dim B_\frakn. \]
        Indeed, in any case, we have an exact sequence
        \[ 0 \to I/(I\cap \frakm^2) \to \frakm/\frakm^2 \to \frakn/\frakn^2 \to 0. \]
        Hence \(\dim_\rkk I/(I\cap \frakm^2) = n - \dim B_\frakn\).
        There is a \(\rkk(\frakm)\)-linear map
        \[ I/(I\cap \frakm^2) \to \rkk(\frakm)^n, \quad [f] \mapsto (\P_1(f), \ldots, \P_n(f))^T, \]
        and every row of the Jacobian matrix \(J\) is in the image of this map.
        Thus, the rank of \(J\) is at most \(n - \dim B_\frakn\).

        Hence if \(\rank J = n - \dim B_\frakn\), we can still see that \(B\) is regular at \(\frakn\).
        However, the converse does not hold in general.
    \end{remark}

    \begin{proposition}\label{prop: regularity under base field extension}
        Let \(\kk\) be a field, \(\kkk\) the algebraic closure of \(\kk\), \(A\) a \(\kk\)-algebra of finite type and \(A_\kkk \coloneqq A \ten_{\kk} \kk\).
        \Yang{Suppose \(A_\kkk\) is integral.}
        Let \(\frakm \in \mSpec A\) and \(\frakm'\) be a maximal ideal of \(A_\kkk\) lying over \(\frakm\).
        Then 
        \begin{enumerate}
            \item If \(A_\kkk\) is regular at \(\frakm'\), then \(A\) is regular at \(\frakm\);
            \item suppose \(\rkk(\frakm)\) is separable over \(\kk\), the converse holds.
        \end{enumerate}
    \end{proposition}
    \begin{proof}
        Regarding \(J_\frakm\) and \(J_{\frakm'}\) as matrices with entries in \(\kkk\), they are the same and hence have the same rank.
        If \(A_\kkk\) is regular at \(\frakm'\), since \(\rkk(\frakm) = \kkk\), then \(\rank J_{\frakm'} = n - \dim A_{\kkk,\frakm'}\).
        Note that \(\dim A_{\kkk,\frakm'} = \trdeg(\fkk(A_\kkk)/\kkk) = \trdeg(\fkk(A)/\kk) = \dim A_\frakm\), we have \(\rank J_{\frakm} = n - \dim A_\frakm\).
        Hence \(A\) is regular at \(\frakm\).

        Conversely, suppose \(A\) is regular at \(\frakm\) and \(\rkk(\frakm)\) is separable over \(\kk\).
        Then \(\rank J_\frakm = n - \dim A_\frakm\).
        Hence \(A_\kkk\) is regular at \(\frakm'\).
        \Yang{To be modified.}
    \end{proof}

    
    \begin{proposition}\label{prop: smoothness is geometric regularity, affine version}
        Let \(\kk\) be a field and \(A\) an integral \(\kk\)-algebra of finite type and of dimension $n$.
        Let \(\kkk\) be the algebraic closure of \(\kk\) and \(A_\kkk \coloneqq A \ten_{\kk} \kkk\).
        Then \(A\) is smooth at \(\frakp \in \Spec A\) if and only if \(A_\kkk\) is regular at every \(\frakm'\) over \(\frakm\).
   \end{proposition}
    \begin{proof}
        Since \(\Omega_{A_\kkk/\kkk} \cong \Omega_{A/\kk} \ten_A A_\kkk\) is free of rank \(n\) if and only if \(\Omega_{A/\kk}\) is free of rank \(n\),
        we can assume that \(\kk = \kkk\).
        If \(A\) is smooth at \(\frakp\), then \(\Omega_{A_\frakp/\kk} \cong \bigoplus A_\frakp \d f_i\) is free of rank \(n\).
        Let \(\frakP_i \in \Der_\kkk(A_\frakm, A_\frakm)\) be the derivation defined by \(\d f_i \mapsto 1\) and \(\d T_j \mapsto 0\) for \(j \neq i\).
        Then we have \(\P_i f_j = \delta_{ij}\) for \(1 \leq i, j \leq n\).
        Then similar to above argument, we have an isomorphism
        \[ \frakm/\frakm^2 \xrightarrow{(\P_1,\ldots,\P_n)^T} \kkk^n. \]
        This shows that \(A_\kkk\) is regular at \(\frakm\).

        Conversely, suppose \(A_\kkk\) is regular at \(\frakm\).
        Note that \(\frakm/\frakm^2 \to \Omega_{A,\kkk} \ten_A \kkk\) is surjective since \(\Omega_{A_\kkk/\kkk} = 0\).
        Then by Nakayama's lemma, \(\Omega_{A_\frakm/\kkk}\) is generated by \(n\) elements as an \(A_\frakm\)-module.
        
        Note that \(\dim_{\fkk(A)} \Omega_{\fkk(A)/\kk} = \trdeg (\fkk(A)/\kk) = \dim A_\frakm = n\).
        \Yang{By induction on transcendental degree.}

        \Yang{By Nakayama's Lemma, \(\Omega_{A_\frakm/\kk}\) is free of rank \(n\) as an \(A_\frakm\)-module.}
        

        \Yang{To be completed.}
    \end{proof}


    \begin{example}\label{eg: regular but not smooth}
        Let \(\kk\) be an imperfect field of characteristic \(p > 2\).
        Suppose \(\alpha = \beta^p \in \kk\) and \(\beta\) is not in \(\kk\).
        Let \(A = \kk[x,y]/(x^2 - y^p - \alpha)\) and \(\frakm = (x, y^p-\alpha) = (x)\).
        Note that \(\frakm\) is principal, so \(A\) is regular at \(\frakm\).
        However, 
        \[ J_\frakm = \left( \frac{\P }{\P x}(x^2-y^p-\alpha), \frac{\P}{\P y}(y^p-\alpha) \right) = \left( 2x, 0 \right) = (0,0) \in M_{1\times 2}(\rkk(\frakm)). \]
        Thus, \(A\) is not smooth at \(\frakm\).
        From the view of differentials, we have
        \[ \Omega_{A_\frakm/\kk} = A_\frakm \d x \oplus A_\frakm \d y / A_\frakm \cdot x\d x = \rkk(\frakm) \d x \oplus A_\frakm \d y, \]
        which is not free as an \(A_\frakm\)-module.
    \end{example}

